{% extends 'base.html' %}
{% load bootstrap3 %}
{% load static %}

{% block bootstrap3_title %}{{ device_id }} | ITLab SSL{% endblock %}

{% block head %}
<style>
  .panel-body {
    padding: 0;
  }

  .panel-body>.table {
    margin-bottom: 0px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="row clearfix">
    <div class="col-md-12 column">
      <ul class="breadcrumb">
        <li>
          <a href="{% url 'home' %}">Home</a>
        </li>
        <li>
          <a href="{% url 'device_list' %}">Device List</a>
        </li>
        <li class="active">
          Device Info
        </li>
      </ul>
      <div class="page-header">
        <h3>{{ device_id }}</h3>
      </div>
    </div>
  </div>
  <div class="row clearfix">
    <div class="col-md-6 column">
      {% if device_info %}
      <div class="alert alert-info">
        <strong id="timestamp">{{ device_info.timestamp | default_if_none:"Disconnected" }}</strong>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <tbody>
            <tr>
              <th class="col-xs-8">Temperature</th>
              <td id="temperature">{{ device_info.temperature | default_if_none:"null" }} °C</td>
            </tr>
            <tr>
              <th>Humidity</th>
              <td id="humidity">{{ device_info.humidity | default_if_none:"null" }} %</td>
            </tr>
            <tr>
              <th>PM2.5</th>
              <td id="pmat25">{{ device_info.pmat25 | default_if_none:"null" }} μg/m<sup>3</sup></td>
            </tr>
            <tr>
              <th>Loudness</th>
              <td id="loudness">{{ device_info.loudness | default_if_none:"null" }} dB</td>
            </tr>
            <tr>
              <th>Light Intensity</th>
              <td id="light_intensity">{{ device_info.light_intensity | default_if_none:"null" }} lux</td>
            </tr>
            <tr>
              <th>UV Intensity</th>
              <td id="uv_intensity">{{ device_info.uv_intensity | default_if_none:"null" }} mW/cm<sup>2</sup></td>
            </tr>
            <tr>
              <th>LED Status</th>
              <td id="led_status">{{ device_info.led_status | default_if_none:"null" }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-info">
        <strong id="timestamp">Disconnected</strong>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <tbody>
            <tr>
              <th class="col-xs-8">Temperature</th>
              <td id="temperature">null °C</td>
            </tr>
            <tr>
              <th>Humidity</th>
              <td id="humidity">null %</td>
            </tr>
            <tr>
              <th>PM2.5</th>
              <td id="pmat25">null μg/m<sup>3</sup></td>
            </tr>
            <tr>
              <th>Loudness</th>
              <td id="loudness">null dB</td>
            </tr>
            <tr>
              <th>Light Intensity</th>
              <td id="light_intensity">null lux</td>
            </tr>
            <tr>
              <th>UV Intensity</th>
              <td id="uv_intensity">null mW/cm<sup>2</sup></td>
            </tr>
            <tr>
              <th>LED Status</th>
              <td id="led_status">null</td>
            </tr>
          </tbody>
        </table>
      </div>
      {% endif %}
      {% if request.user.is_staff %}
      <p>
        <button disabled id="led_ctrl_on" class="btn btn-success .btn-lg" type="button" onclick="led_ctrl(1);">Turn ON
          LED</button>
        <button disabled id="led_ctrl_off" class="btn btn-danger .btn-lg" type="button" onclick="led_ctrl(0);">Turn OFF
          LED</button>
      </p>
      {% endif %}
    </div>
    <div class="col-md-6 column">
      <div class="embed-responsive embed-responsive-16by9">
        <video id="video1" class="embed-responsive-item" playsinline controls muted autoplay></video>
      </div>
      <!-- <p></p>
      <div class="embed-responsive embed-responsive-16by9">
        <video id="video2" class="embed-responsive-item" playsinline controls muted autoplay></video>
      </div> -->
    </div>
  </div>
</div>
{% endblock %}

{% block extra_script %}
<!-- Play HLS Video -->
<script src="/static/home/plugin/hls.min-0.12.2.js"></script>
<script>
  var video = document.getElementById('video1');
  if (Hls.isSupported()) {
    var hls = new Hls();
    hls.loadSource('{{ hls_url }}{{ device_id }}.m3u8');
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, function () {
      video.play();
    });
  }
  else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = '{{ hls_url }}{{ device_id }}.m3u8';
    video.addEventListener('loadedmetadata', function () {
      video.play();
    });
  }
</script>

<!-- Play FLV Video -->
<!-- <script src="https://cdn.jsdelivr.net/npm/flv.js@latest"></script>
<script>
  if (flvjs.isSupported()) {
      var video = document.getElementById('video2');
      var flvPlayer = flvjs.createPlayer({
          type: 'flv',
          url: 'https://itlab7f.ddns.net:7777/live/{{ device_id }}.flv',
          hasVideo: true,
          hasAudio: false,
          withCredentials: false,
          isLive: true
      });
      flvPlayer.attachMediaElement(video);
      flvPlayer.load();
      flvPlayer.play();
  }
</script> -->

{% if request.user.is_staff %}
<script>
  function ui_disabled(disable) {
    document.querySelector('#led_ctrl_on').disabled = disable;
    document.querySelector('#led_ctrl_off').disabled = disable;

    if (disable == true) {
      document.querySelector('#timestamp').innerHTML = 'Disconnected';
    }
  }

  function led_ctrl(led_status) {
    if (socket.readyState == 1) {
      if (document.querySelector('#timestamp').innerHTML != 'Disconnected') {

        var msg = {
          'cmd': 'led_ctrl',
          'data': { 'led_status': led_status }
        };
        socket.send(JSON.stringify(msg));
        console.log(JSON.stringify(msg));

      } else {
        alert('Edge Device is disconnected.');
      }
    } else {
      alert('WebSocket connection closed unexpectedly.\nPlease refresh the page.');
    }
  }
</script>
{% else %}
<script>
  function ui_disabled(disable) {
    if (disable == true) {
      document.querySelector('#timestamp').innerHTML = 'Disconnected';
    }
  }
</script>
{% endif %}

<script>
  document.querySelector('#led_status').innerHTML = Number(document.querySelector('#led_status').innerHTML) ? 'on' : 'off';

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function check_edge() {
    while (true) {
      var time = document.querySelector('#timestamp').innerHTML;

      var if_disconnected = (time == "Disconnected") || ((new Date() - new Date(time)) > 15 * 1000);

      ui_disabled(if_disconnected);

      await sleep(10 * 1000);
    }
  }

  check_edge();
</script>

<!-- Websocket Get Info -->
<script>
  var device_id = '{{ device_id }}';

  var ws_scheme = window.location.protocol == "https:" ? "wss://" : "ws://";

  var socket = new WebSocket(ws_scheme + window.location.host + '/ws/browser/device/' + device_id);

  socket.onmessage = function (e) {
    var raw = JSON.parse(e.data);
    if (raw['cmd'] == 'update_info') {
      document.querySelector('#timestamp').innerHTML = raw['data']['timestamp'];
      document.querySelector('#temperature').innerHTML = raw['data']['temperature'] + ' °C';
      document.querySelector('#humidity').innerHTML = raw['data']['humidity'] + ' %';
      document.querySelector('#pmat25').innerHTML = raw['data']['pmat25'] + ' μg/m<sup>3</sup>';
      document.querySelector('#loudness').innerHTML = raw['data']['loudness'] + ' dB';
      document.querySelector('#light_intensity').innerHTML = raw['data']['light_intensity'] + ' lux';
      document.querySelector('#uv_intensity').innerHTML = raw['data']['uv_intensity'] + ' mW/cm<sup>2</sup>';
      document.querySelector('#led_status').innerHTML = Number(raw['data']['led_status']) ? 'on' : 'off';
      ui_disabled(false);
    }
  };

  socket.onclose = function (e) {
    alert('WebSocket connection closed unexpectedly.\nPlease refresh the page.');
    ui_disabled(true);
  };
</script>
{% endblock %}