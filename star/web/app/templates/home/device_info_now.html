{% extends 'base.html' %}
{% load bootstrap3 %}
{% load static %}

{% block bootstrap3_title %}Device Info | ITLab SSL{% endblock %}

{% block head %}
<style>
  .panel-body {
    padding: 0;
  }

  .panel-body>.table {
    margin-bottom: 0px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="row clearfix">
    <div class="col-md-12 column">
      <ul class="breadcrumb">
        <li>
          <a href="{% url 'home' %}">Home</a>
        </li>
        <li>
          <a href="{% url 'device_list' %}">Device List</a>
        </li>
        <li class="active">
          Device Info
        </li>
      </ul>
      <div class="page-header">
        <h3>{{ device_name }}</h3>
      </div>
    </div>
  </div>
  <div class="row clearfix">
    <div class="col-md-6 column">
      {% if device_info %}
      <div class="alert alert-info">
        <strong id="timestamp">
          {{ device_info.timestamp | date:"Y-m-d H:i:s O" | default_if_none:"null" }}
        </strong>
      </div>

      <div class="table-responsive">
        <table class="table table-striped">
          <tbody>
            <tr>
              <th class="col-xs-8">Temperature</th>
              <td id="temperature">{{ device_info.temperature | default_if_none:"null" }} °C</td>
            </tr>
            <tr>
              <th>Humidity</th>
              <td id="humidity">{{ device_info.humidity | default_if_none:"null" }} %</td>
            </tr>
            <tr>
              <th>PM2.5</th>
              <td id="pm2_5">{{ device_info.pm2_5 | default_if_none:"null" }} μg/m<sup>3</sup></td>
            </tr>
            <tr>
              <th>Loudness</th>
              <td id="loudness">{{ device_info.loudness | default_if_none:"null" }} dB</td>
            </tr>
            <tr>
              <th>Light Intensity</th>
              <td id="light_intensity">{{ device_info.light_intensity | default_if_none:"null" }} lux</td>
            </tr>
            <tr>
              <th>UV Intensity</th>
              <td id="uv_intensity">{{ device_info.uv_intensity | default_if_none:"null" }} mW/cm<sup>2</sup></td>
            </tr>
            <tr>
              <th>IR Sensor</th>
              <td id="ir_sensed">{{ device_info.ir_sensed | default_if_none:"null" }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title" id="timestamp">
            No Latest Data
          </h3>
        </div>
        <div class="panel-body table-responsive">
          <table class="table table-striped">
            <tbody>
              <tr>
                <th class="col-xs-8">Temperature</th>
                <td id="temperature">null °C</td>
              </tr>
              <tr>
                <th>Humidity</th>
                <td id="humidity">null %</td>
              </tr>
              <tr>
                <th>PM2.5</th>
                <td id="pm2_5">null μg/m<sup>3</sup></td>
              </tr>
              <tr>
                <th>Loudness</th>
                <td id="loudness">null dB</td>
              </tr>
              <tr>
                <th>Light Intensity</th>
                <td id="light_intensity">null lux</td>
              </tr>
              <tr>
                <th>UV Intensity</th>
                <td id="uv_intensity">null mW/cm<sup>2</sup></td>
              </tr>
              <tr>
                <th>IR Sensor</th>
                <td id="ir_sensed">null</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </div>
    <div class="col-md-6 column">
      <div algin="center" class="embed-responsive embed-responsive-16by9">
        <video id="video1" class="embed-responsive-item" controls muted autoplay></video>
      </div>
      <p></p>
      <div algin="center" class="embed-responsive embed-responsive-16by9">
        <!-- <video id="video2" class="embed-responsive-item" controls muted autoplay></video> -->
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_script %}
<!-- Play HLS Video -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
  var video = document.getElementById('video1');
  if (Hls.isSupported()) {
    var hls = new Hls();
    hls.loadSource('{{ hls_url }}{{ device_name }}.m3u8');
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, function () {
      video.play();
    });
  }
  else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = '{{ hls_url }}{{ device_name }}.m3u8';
    video.addEventListener('loadedmetadata', function () {
      video.play();
    });
  }
</script>


<!-- Play FLV Video -->
<!-- <script src="https://cdn.jsdelivr.net/npm/flv.js@latest"></script>
<script>
  if (flvjs.isSupported()) {
      var video = document.getElementById('video2');
      var flvPlayer = flvjs.createPlayer({
          type: 'flv',
          url: 'https://itlab7f.ddns.net:7777/live/{{ device_name }}.flv',
          hasVideo: true,
          hasAudio: false,
          withCredentials: false,
          isLive: true
      });
      flvPlayer.attachMediaElement(video);
      flvPlayer.load();
      flvPlayer.play();
  }
</script> -->


<!-- Websocket Get Info -->
<script>
  var device_name = '{{ device_name }}';

  var ws_scheme = window.location.protocol == "https:" ? "wss://" : "ws://";

  var socket = new WebSocket(ws_scheme + window.location.host + '/ws/device/' + device_name);

  socket.onmessage = function (e) {
    var data = JSON.parse(e.data);
    document.querySelector('#timestamp').innerHTML = data['timestamp'];
    document.querySelector('#temperature').innerHTML = data['temperature'] + ' °C';
    document.querySelector('#humidity').innerHTML = data['humidity'] + ' %';
    document.querySelector('#pm2_5').innerHTML = data['pm2_5'] + ' μg/m<sup>3</sup>';
    document.querySelector('#loudness').innerHTML = data['loudness'] + ' dB';
    document.querySelector('#light_intensity').innerHTML = data['light_intensity'] + ' lux';
    document.querySelector('#uv_intensity').innerHTML = data['uv_intensity'] + ' mW/cm<sup>2</sup>';
    document.querySelector('#ir_sensed').innerHTML = data['ir_sensed'];
  };

  socket.onclose = function (e) {
    alert('Connection closed unexpectedly.\nPlease refresh the page.');
    document.querySelector('#timestamp').innerHTML = 'Disconnected.'
  };
</script>
{% endblock %}